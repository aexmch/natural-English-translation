/**
 * Chinglish Lab - 反直譯邏輯訓練應用程式
 * * 【GitHub 上傳指南】
 * 1. 使用 Vite 建立 React 專案: npm create vite@latest my-app -- --template react
 * 2. 進入資料夾並安裝套件: 
 * npm install
 * npm install lucide-react tailwindcss postcss autoprefixer
 * 3. 初始化 Tailwind (如尚未配置): npx tailwindcss init -p
 * 4. 將此檔案內容複製並覆蓋專案中的 src/App.jsx
 * 5. 執行 npm run dev 啟動專案
 * * 本程式採用單一檔案結構，符合現代 React 開發慣例，內含完整邏輯、樣式與數據。
 */

import React, { useState } from 'react';
import { 
  CheckCircle2, Lightbulb, ChevronRight, RefreshCw, BookOpen, 
  MessageSquare, Languages, Info, Trophy, Star, Flame, Award, PartyPopper 
} from 'lucide-react';

// --- 數據定義 (18 道題目) ---
const quizData = [
  // --- Category 1: 動詞誤用 & 句型結構 ---
  {
    id: 1,
    chinese: "這個告示牌叫大家不要亂丟垃圾。",
    chinglish: "The sign noticed the public don't throw trash.",
    natural: "The sign reminds the public not to litter.",
    alternatives: ["The sign says 'No Littering'.", "The sign warns people against littering."],
    category: "動詞誤用 & 句型結構",
    analysis: "1. 誤用 noticed (察覺)。 2. 缺少 'not to'。Tell/Remind 某人做某事需使用 'to V'。",
    explanation: "英文中告示牌『說話』用 says，『提醒』用 reminds。"
  },
  {
    id: 1.1,
    chinese: "這個規定要求我們穿制服。",
    chinglish: "This rule requests us wear uniforms.",
    natural: "This rule requires us to wear uniforms.",
    alternatives: ["We are required to wear uniforms by this rule.", "The rule states that we must wear uniforms."],
    category: "動詞誤用 & 句型結構",
    analysis: "Require/Request 後面接人做某事，必須接不定詞 'to V'。",
    explanation: "這類『要求/命令/建議』的動詞，後方的動作需要 to 來連接。"
  },
  {
    id: 1.2,
    chinese: "簡訊通知我要開會。",
    chinglish: "The message noticed me have a meeting.",
    natural: "The message notified me that there is a meeting.",
    alternatives: ["The message reminded me about the meeting.", "The message informed me of the meeting."],
    category: "動詞誤用 & 句型結構",
    analysis: "Notice 是『看見/察覺』，要『告知』某人應用 notify 或 inform。",
    explanation: "中文的『通知』在英文中有主動告知 (Notify) 與被動發現 (Notice) 的區別。"
  },
  // --- Category 2: 副詞位置 ---
  {
    id: 2,
    chinese: "我很喜歡這部電影。",
    chinglish: "I very like this movie.",
    natural: "I really like this movie.",
    alternatives: ["I like this movie very much.", "I'm a big fan of this movie."],
    category: "副詞位置",
    analysis: "Very 不能修飾動詞。應改用 Really 或放在句尾的 Very much。",
    explanation: "Very 是程度副詞，通常修飾形容詞（Very good），不修飾動詞。"
  },
  {
    id: 2.1,
    chinese: "我非常相信他。",
    chinglish: "I very believe him.",
    natural: "I strongly believe him.",
    alternatives: ["I really believe him.", "I believe him completely."],
    category: "副詞位置",
    analysis: "『非常』相信，英文常用 strongly, truly 或 completely。",
    explanation: "動詞的『強度』在英文中有特定的副詞搭配，而不只是 Very。"
  },
  {
    id: 2.2,
    chinese: "他很怕蜘蛛。",
    chinglish: "He very fears spiders.",
    natural: "He is very afraid of spiders.",
    alternatives: ["He really fears spiders.", "Spiders terrify him."],
    category: "副詞位置",
    analysis: "如果用動詞 fear，不能加 very。若要用 very，必須用形容詞結構 'is very afraid of'。",
    explanation: "區分動詞 (Fear) 與形容詞 (Afraid) 的用法。"
  },
  // --- Category 3: 動詞搭配 (Collocation) ---
  {
    id: 3,
    chinese: "別忘了吃藥。",
    chinglish: "Don't forget to eat medicine.",
    natural: "Don't forget to take your medicine.",
    alternatives: ["Remember to take your meds.", "You should take your medication on time."],
    category: "動詞搭配 (Collocation)",
    analysis: "英文中服用藥物統一使用 'take'。",
    explanation: "這就是所謂的固定搭配。我們『吃』食物，但『服用』藥物。"
  },
  {
    id: 3.1,
    chinese: "寫日記。",
    chinglish: "Write a diary.",
    natural: "Keep a diary.",
    alternatives: ["Write in a journal.", "Start a diary."],
    category: "動詞搭配 (Collocation)",
    analysis: "『寫』日記強調的是長期保存紀錄的動作，用 keep 更有連貫感。",
    explanation: "Write 是一次性的動作，Keep 才有持續習慣的含意。"
  },
  {
    id: 3.2,
    chinese: "參加考試。",
    chinglish: "Join an exam.",
    natural: "Take an exam.",
    alternatives: ["Sit for an exam.", "Do an exam."],
    category: "動詞搭配 (Collocation)",
    analysis: "Join 是加入組織或活動。參加考試這種測試性質的行為用 take。",
    explanation: "考試是『接受』測試，所以用 Take。"
  },
  // --- Category 4: 虛擬主詞 (It) ---
  {
    id: 4,
    chinese: "今天很熱。",
    chinglish: "Today is very hot.",
    natural: "It is very hot today.",
    alternatives: ["The weather is hot today.", "It's boiling today."],
    category: "虛擬主詞",
    analysis: "描述天氣、時間、距離必須使用虛擬主詞 'It'。",
    explanation: "英文句子像天平，必須有一個虛擬的 'It' 來平衡主格位置。"
  },
  {
    id: 4.1,
    chinese: "現在五點了。",
    chinglish: "Now is five o'clock.",
    natural: "It is five o'clock now.",
    alternatives: ["It's 5 PM.", "The time is 5:00."],
    category: "虛擬主詞",
    analysis: "Now 是副詞，不能當主詞。時間必須由 It 引導。",
    explanation: "時間句型中，It 代表的是『當下的狀態』。"
  },
  {
    id: 4.2,
    chinese: "到機場要花一小時。",
    chinglish: "To the airport needs one hour.",
    natural: "It takes an hour to get to the airport.",
    alternatives: ["Getting to the airport takes an hour.", "The drive to the airport is one hour."],
    category: "虛擬主詞",
    analysis: "『花費時間』通常使用 'It takes (time) to do something' 句型。",
    explanation: "這是最常用的生活句型，主詞永遠是 It。"
  },
  // --- Category 5: 存在句型 (There be) ---
  {
    id: 5,
    chinese: "這裡有很多人。",
    chinglish: "Here has many people.",
    natural: "There are many people here.",
    alternatives: ["Many people are gathering here.", "This place is crowded."],
    category: "存在句型",
    analysis: "表達某處有某物存在，必須用 'There is/are'。Has 只能用於主動擁有的主語。",
    explanation: "地點不能『擁有』人，只能說『那裡存在著』人。"
  },
  {
    id: 5.1,
    chinese: "桌子上有杯咖啡。",
    chinglish: "The table has a cup of coffee.",
    natural: "There is a cup of coffee on the table.",
    alternatives: ["A cup of coffee is on the table.", "Someone left a coffee on the table."],
    category: "存在句型",
    analysis: "除非桌子會長出咖啡，否則請用 There is。",
    explanation: "區分『具備性質』與『地理位置的存在』。"
  },
  {
    id: 5.2,
    chinese: "冰箱裡沒有牛奶了。",
    chinglish: "In the fridge has no milk.",
    natural: "There is no milk in the fridge.",
    alternatives: ["The fridge is out of milk.", "We've run out of milk in the fridge."],
    category: "存在句型",
    analysis: "中文喜歡把地點放前面，但英文必須先說『有/沒有』。",
    explanation: "There is/are 是英文表達『有無』的最核心句型。"
  },
  // --- Category 6: 介系詞遺漏 ---
  {
    id: 6,
    chinese: "等我五分鐘。",
    chinglish: "Wait me five minutes.",
    natural: "Wait for me for five minutes.",
    alternatives: ["Give me five minutes.", "Could you wait for me?"],
    category: "介系詞遺漏",
    analysis: "Wait 是不及物動詞，後面接人必須加 'for'。",
    explanation: "中文動詞通常直接吃掉受詞，但英文動詞常需要一座介系詞橋樑。"
  },
  {
    id: 6.1,
    chinese: "聽老師說話。",
    chinglish: "Listen the teacher.",
    natural: "Listen to the teacher.",
    alternatives: ["Listen to what the teacher says.", "Pay attention to the teacher."],
    category: "介系詞遺漏",
    analysis: "Listen 後面接對象時，永遠要加 'to'。",
    explanation: "聽音樂是 Listen to music，聽我是 Listen to me。"
  },
  {
    id: 6.2,
    chinese: "回覆我的電子郵件。",
    chinglish: "Reply my email.",
    natural: "Reply to my email.",
    alternatives: ["Please respond to my email.", "Answer my email."],
    category: "介系詞遺漏",
    analysis: "Reply 後面接訊息時，必須加 'to'。若不加介系詞，應改用 Answer。",
    explanation: "Reply to = Respond to = Answer (無 to)。"
  }
];

// --- 輔助組件 ---
const CategoryBadge = ({ category }) => {
  const colors = {
    "動詞誤用 & 句型結構": "bg-blue-100 text-blue-700",
    "副詞位置": "bg-purple-100 text-purple-700",
    "動詞搭配 (Collocation)": "bg-green-100 text-green-700",
    "虛擬主詞": "bg-orange-100 text-orange-700",
    "存在句型": "bg-red-100 text-red-700",
    "介系詞遺漏": "bg-teal-100 text-teal-700"
  };
  return (
    <span className={`px-3 py-1 rounded-full text-xs font-bold ${colors[category] || "bg-gray-100"}`}>
      {category}
    </span>
  );
};

// --- 主應用程式 ---
export default function App() {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [showResult, setShowResult] = useState(false);
  const [userAttempt, setUserAttempt] = useState("");
  const [completed, setCompleted] = useState([]);
  
  const [score, setScore] = useState(0);
  const [streak, setStreak] = useState(0);
  const [lastBonus, setLastBonus] = useState(null);
  const [isFinished, setIsFinished] = useState(false);

  const currentTask = quizData[currentIndex];

  const handleReveal = () => {
    if (showResult) return;

    let pointsEarned = 100;
    let bonusType = [];

    // 獎勵機制 1: 積極嘗試 (長度檢核)
    if (userAttempt.trim().length > 5) {
      pointsEarned += 20;
      bonusType.push("勇敢嘗試 +20");
    }

    // 獎勵機制 2: 連勝獎勵
    const streakBonus = streak * 10;
    if (streakBonus > 0) {
      pointsEarned += streakBonus;
      bonusType.push(`連勝加成 +${streakBonus}`);
    }

    setShowResult(true);
    setScore(prev => prev + pointsEarned);
    setStreak(prev => prev + 1);
    setLastBonus(bonusType.join(" | "));

    if (!completed.includes(currentTask.id)) {
      setCompleted([...completed, currentTask.id]);
    }
  };

  const nextTask = () => {
    if (completed.length === quizData.length) {
      setIsFinished(true);
      return;
    }
    
    setShowResult(false);
    setUserAttempt("");
    setLastBonus(null);
    setCurrentIndex((prev) => (prev + 1) % quizData.length);
  };

  const resetProgress = () => {
    setCurrentIndex(0);
    setShowResult(false);
    setUserAttempt("");
    setCompleted([]);
    setScore(0);
    setStreak(0);
    setLastBonus(null);
    setIsFinished(false);
  };

  const getRank = () => {
    if (score < 500) return "語言觀察員";
    if (score < 1200) return "英語除錯探員";
    if (score < 2000) return "道地表達導師";
    return "除錯大師";
  };

  // --- 視圖渲染 ---

  // 1. 遊戲結束畫面
  if (isFinished) {
    return (
      <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4 font-sans">
        <div className="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl p-10 text-center animate-in zoom-in-95 duration-500 border border-slate-100">
          <div className="w-24 h-24 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner">
            <PartyPopper className="w-12 h-12 text-yellow-600" />
          </div>
          <h1 className="text-3xl font-black text-slate-800 mb-2 tracking-tight">訓練圓滿達成！</h1>
          <p className="text-slate-500 mb-8 font-medium">你已成功掌握了 {quizData.length} 個關鍵邏輯</p>
          
          <div className="bg-indigo-50 rounded-[2rem] p-8 mb-8 border border-indigo-100">
            <div className="text-xs text-indigo-400 font-black uppercase tracking-widest mb-2">FINAL SCORE</div>
            <div className="text-6xl font-black text-indigo-600 mb-4">{score}</div>
            <div className="flex items-center justify-center gap-2 text-indigo-800 font-bold bg-white py-3 px-6 rounded-2xl shadow-sm border border-indigo-50">
              <Award className="w-6 h-6 text-indigo-500" />
              等級：{getRank()}
            </div>
          </div>

          <button 
            onClick={resetProgress}
            className="w-full py-5 bg-slate-900 hover:bg-black text-white font-black rounded-2xl transition-all flex items-center justify-center gap-3 shadow-xl hover:scale-[1.02] active:scale-95"
          >
            <RefreshCw className="w-6 h-6" />
            重新開始新的旅程
          </button>
        </div>
      </div>
    );
  }

  // 2. 訓練主畫面
  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900 selection:bg-indigo-100 selection:text-indigo-900">
      <div className="max-w-3xl mx-auto">
        
        {/* HUD: 抬頭顯示資訊 */}
        <header className="mb-8">
          <div className="flex flex-col md:flex-row justify-between items-center gap-6">
            <div className="flex items-center gap-4">
              <div className="p-4 bg-indigo-600 rounded-[1.2rem] shadow-xl shadow-indigo-100 rotate-3">
                <BookOpen className="w-7 h-7 text-white" />
              </div>
              <div>
                <h1 className="text-2xl font-black text-slate-900 leading-none mb-1 tracking-tight">Chinglish Lab</h1>
                <p className="text-[10px] text-slate-400 font-black uppercase tracking-widest">Logic-First Training</p>
              </div>
            </div>

            <div className="flex items-center gap-3">
              <div className="bg-white px-6 py-3 rounded-[1.5rem] shadow-sm border border-slate-200/60 flex items-center gap-5">
                <div className="flex flex-col items-end">
                  <span className="text-[9px] text-slate-400 font-black uppercase tracking-tighter">Current Score</span>
                  <span className="text-2xl font-black text-slate-800 leading-none tabular-nums">{score}</span>
                </div>
                <div className="w-px h-10 bg-slate-100"></div>
                <div className="flex flex-col items-end">
                  <span className="text-[9px] text-slate-400 font-black uppercase tracking-tighter">Win Streak</span>
                  <div className="flex items-center gap-1.5">
                    <Flame className={`w-5 h-5 ${streak > 0 ? 'text-orange-500 animate-pulse fill-orange-500' : 'text-slate-200'}`} />
                    <span className="text-2xl font-black text-slate-800 leading-none tabular-nums">{streak}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div className="mt-8">
            <div className="flex justify-between items-end mb-2.5 px-1">
              <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Progress</span>
              <span className="text-[10px] font-black text-indigo-500 uppercase tracking-widest">{completed.length} / {quizData.length} Completed</span>
            </div>
            <div className="w-full h-4 bg-white rounded-full overflow-hidden p-1 shadow-inner border border-slate-100">
              <div 
                className="h-full bg-gradient-to-r from-indigo-500 via-indigo-400 to-indigo-500 rounded-full transition-all duration-1000 ease-out" 
                style={{ width: `${(completed.length / quizData.length) * 100}%` }}
              ></div>
            </div>
          </div>
        </header>

        {/* 核心內容區塊 */}
        <main className="bg-white rounded-[2.5rem] shadow-2xl shadow-slate-200/50 overflow-hidden border border-slate-100 relative">
          {/* 連勝與加分彈出提示 */}
          {lastBonus && (
            <div className="absolute top-6 right-10 z-10 animate-bounce">
              <div className="bg-yellow-400 text-yellow-900 text-[10px] font-black px-4 py-1.5 rounded-full shadow-lg border-2 border-white uppercase tracking-tighter">
                {lastBonus}
              </div>
            </div>
          )}

          <div className="p-8 md:p-12">
            <div className="flex justify-between items-center mb-10">
              <CategoryBadge category={currentTask.category} />
              <div className="flex items-center gap-2 bg-slate-50 px-4 py-1.5 rounded-full border border-slate-100 shadow-sm">
                <Trophy className="w-4 h-4 text-yellow-500 fill-yellow-200" />
                <span className="text-[10px] font-black text-slate-600 uppercase tracking-widest">{getRank()}</span>
              </div>
            </div>

            {/* 目標語句 */}
            <div className="mb-10 relative group">
              <div className="absolute -left-2 top-0 bottom-0 w-2 bg-indigo-600 rounded-full transition-all"></div>
              <label className="text-[10px] font-black text-indigo-500 uppercase tracking-[0.2em] mb-3 flex items-center gap-2 px-5">
                <Languages className="w-4 h-4" /> Translation Goal
              </label>
              <div className="text-4xl font-black text-slate-800 px-5 py-1 leading-[1.2]">
                「{currentTask.chinese}」
              </div>
            </div>

            {/* 常見錯誤展示 */}
            <div className="mb-12">
              <div className="flex items-center gap-3 mb-4">
                <span className="text-[10px] font-black text-red-400 uppercase tracking-widest">Typical Mistake</span>
                <div className="flex-grow h-px bg-red-100"></div>
              </div>
              <div className="text-xl font-semibold text-red-900/40 p-8 bg-red-50/20 rounded-[2rem] border-2 border-dashed border-red-100/50 flex items-start gap-5 italic relative overflow-hidden group">
                <div className="w-10 h-10 rounded-2xl bg-red-50 flex items-center justify-center shrink-0 border border-red-100 shadow-sm group-hover:scale-110 transition-transform">
                  <span className="text-red-500 text-lg font-black">✕</span>
                </div>
                <div className="pt-1">{currentTask.chinglish}</div>
              </div>
            </div>

            {/* 互動互動區 */}
            {!showResult ? (
              <div className="space-y-5">
                <div className="flex items-center justify-between px-3">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block">
                    Your Refined Version:
                  </label>
                  <div className="flex items-center gap-1.5">
                    <Star className="w-3.5 h-3.5 text-yellow-500 fill-yellow-500" />
                    <span className="text-[9px] text-slate-400 font-bold uppercase tracking-tighter italic">Try writing to earn +20 bonus</span>
                  </div>
                </div>
                <textarea
                  className="w-full p-8 border-2 border-slate-100 rounded-[2rem] focus:border-indigo-500 transition-all outline-none italic text-xl bg-slate-50/50 focus:bg-white focus:shadow-2xl placeholder:text-slate-300 shadow-inner"
                  placeholder="Think before you check..."
                  rows="2"
                  value={userAttempt}
                  onChange={(e) => setUserAttempt(e.target.value)}
                />
                <button
                  onClick={handleReveal}
                  className="w-full py-6 bg-indigo-600 hover:bg-indigo-700 text-white font-black rounded-[2rem] shadow-2xl shadow-indigo-100 transition-all active:scale-95 flex items-center justify-center gap-4 group relative overflow-hidden"
                >
                  <div className="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                  <Lightbulb className="w-6 h-6 group-hover:rotate-12 transition-transform" />
                  <span className="text-lg">Reveal the Natural Way</span>
                </button>
              </div>
            ) : (
              <div className="animate-in fade-in slide-in-from-bottom-10 duration-700">
                {/* 道地答案區 */}
                <div className="mb-10 space-y-6">
                  <div>
                    <label className="text-[10px] font-black text-green-600 uppercase tracking-[0.2em] mb-4 block px-3">
                      Standard Natural English
                    </label>
                    <div className="text-3xl font-black text-slate-900 p-10 bg-green-50/50 rounded-[3rem] border-2 border-green-200 flex items-center gap-6 relative shadow-sm group">
                      <div className="absolute -top-3 -right-3 p-4 bg-green-500 rounded-2xl shadow-lg border-4 border-white">
                        <CheckCircle2 className="w-7 h-7 text-white" />
                      </div>
                      <div className="leading-tight">{currentTask.natural}</div>
                    </div>
                  </div>
                  
                  {currentTask.alternatives && (
                    <div className="bg-slate-50/30 rounded-[1.5rem] p-8 border border-slate-200/60">
                      <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4 block">
                        Native Variations (Equally Correct)
                      </label>
                      <ul className="space-y-4">
                        {currentTask.alternatives.map((alt, i) => (
                          <li key={i} className="text-slate-700 flex items-center gap-4 text-base font-semibold">
                            <div className="w-2 h-2 bg-indigo-400 rounded-full shadow-sm"></div>
                            {alt}
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}
                </div>

                {/* 分析說明區 */}
                <div className="bg-amber-50 rounded-[3rem] p-12 border border-amber-100 relative shadow-inner overflow-hidden">
                  <div className="absolute -top-3 left-12 px-8 py-2 bg-amber-400 text-white text-[10px] font-black rounded-full shadow-xl tracking-[0.3em]">
                    EXPERT INSIGHT
                  </div>
                  <h3 className="font-black text-amber-950 flex items-center gap-3 mb-6 text-xl">
                    <MessageSquare className="w-7 h-7 text-amber-600" />
                    為什麼直譯會出錯？
                  </h3>
                  <p className="text-amber-900 leading-relaxed mb-10 font-medium text-xl opacity-90">
                    {currentTask.analysis}
                  </p>
                  <div className="bg-white/90 p-8 rounded-[2rem] border border-amber-200 shadow-sm relative">
                    <div className="flex items-center gap-3 mb-4">
                      <Info className="w-6 h-6 text-amber-500" />
                      <span className="font-black text-amber-900/70 text-sm tracking-tight">邏輯思維轉換 (Mental Flip)：</span>
                    </div>
                    <p className="text-amber-900 text-lg italic leading-relaxed font-medium">
                      {currentTask.explanation}
                    </p>
                  </div>
                </div>

                {/* 下一步按鈕 */}
                <button
                  onClick={nextTask}
                  className="w-full mt-12 py-7 bg-slate-900 hover:bg-black text-white font-black rounded-[2.2rem] transition-all flex items-center justify-center gap-4 shadow-2xl group hover:scale-[1.01] active:scale-95"
                >
                  <span className="text-xl">Next Challenge</span>
                  <div className="bg-white/20 p-2 rounded-full group-hover:translate-x-2 transition-transform">
                    <ChevronRight className="w-6 h-6" />
                  </div>
                </button>
              </div>
            )}
          </div>
        </main>

        <footer className="mt-16 text-center space-y-6">
           <button 
              onClick={resetProgress}
              className="px-8 py-3 rounded-full text-slate-400 hover:text-indigo-600 hover:bg-white hover:shadow-sm transition-all text-[10px] font-black tracking-[0.2em] border border-transparent hover:border-indigo-50"
            >
              <RefreshCw className="w-4 h-4 inline mr-2 opacity-50" />
              RESET ALL PROGRESS
            </button>
            <div className="pt-4 border-t border-slate-200/60 max-w-xs mx-auto">
              <p className="text-slate-300 text-[9px] font-black tracking-[0.3em] uppercase">
                ESL Chinglish Laboratory &copy; 2026
              </p>
            </div>
        </footer>
      </div>
    </div>
  );
}
